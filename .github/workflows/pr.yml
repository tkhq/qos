on: [pull_request]

name: PR

jobs:
  test:
    name: test
    runs-on: ubicloud-standard-2
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Setup Docker
        uses: ./.github/actions/docker-setup
      - name: Run tests
        run: make test

  lint:
    name: lint
    runs-on: ubicloud-standard-2
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Setup Docker
        uses: ./.github/actions/docker-setup
      - name: Run linting
        run: make lint

  proto-gen:
    name: proto-gen
    runs-on: ubicloud-standard-2
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      - name: Setup buf
        uses: bufbuild/buf-action@4ceee320c664d3bebaf58ed0f5f189954164e203 # v1
        with:
          setup_only: true
      - name: Check for breaking proto changes
        run: |
          # Only run buf breaking if main has proto files (skip on first PR adding protos)
          if git ls-tree -r origin/main --name-only | grep -q '^proto/.*\.proto$'; then
            buf breaking proto --against '.git#branch=origin/main'
          else
            echo "Skipping buf breaking check - no proto files on main branch yet"
          fi
      - name: Run proto-gen
        run: make proto-gen
      - name: Check for uncommitted changes
        run: |
          git diff --exit-code || (echo "Proto generated code is out of sync. Run 'make proto-gen' and commit the changes." && exit 1)

  build-linux-only-crates:
    name: build-linux-only-crates
    runs-on: ubicloud-standard-8
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Setup Docker
        uses: ./.github/actions/docker-setup
      - name: Run build-linux-only
        run: make -j$(nproc) build-linux-only
